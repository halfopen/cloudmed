<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>健康自检</title>
		
		<script src="../js/mui.min.js"></script>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/app.css" rel="stylesheet" />
		<link href="../css/report.css" rel="stylesheet" />
		<script src="../data/question.js" ></script>
		<script src="../js/angular.min.js"></script>
		<script src="../js/angular-animate.min.js"></script>
		<script src="../js/angular-aria.min.js"></script>
		<script src="../js/angular-messages.min.js"></script>
		<script src="../js/diagnosis.js"></script>
		<!-- Angular Material Library -->
		<script src="../js/angular-material.min.js"></script>
		<link rel="stylesheet" href="../css/angular-material.min.css" />
	</head>
	<body ng-app="myApp" ng-controller="myCtrl">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">检测报告</h1>
		</header>
		
		<div class="mui-content" >
			<div class="tip">
				您在{{date}}的体检报告
			</div>
			<div class="col-box">
				<div>面诊结果</div>
				<p>{{faceResult}}</p>
			</div>
			<div class="col-box">
				<div>舌诊结果</div>
				<p>{{tongueResult}}</p>
			</div>
			<div class="col-box">
				<div>结论： {{phy}} {{healthScore}}分 <span class="explain-text" ng-click="showExplainDialog($event)">想知道为什么是这个结果吗？</span></div>
				<p>{{healthState}}
					<!-- 让元素先加载，然后隐藏 防止移动平台下不加载 -->
					<img ng-show="HEALTH_INDEX==0" src="./resource/html/image/xiaolian2.jpg" width="120px" height="120px" />
					<img ng-show="HEALTH_INDEX==1" src="./resource/html/image/xiaolian.jpg" width="120px" height="120px"/>
					<img ng-show="HEALTH_INDEX==2" src="./resource/html/image/pinglian.jpg" width="120px" height="120px"/>
					<img ng-show="HEALTH_INDEX==3" src="./resource/html/image/pinglian2.jpg" width="120px" height="120px"/>
					<img ng-show="HEALTH_INDEX==4" src="./resource/html/image/pinglian3.jpg" width="120px" height="120px"/>
					<!-- <img ng-show="HEALTH_INDEX==0" src="./resource/html/image/xiaolian2.jpg" width="120px" height="120px"/> -->
				</p>
			</div>

			<div class="col-box">
				<div>建议{{stype}}</div>
				<!-- <suggestion stype="{{stype}}"></suggestion> -->
				<div ng-show="stype==0" ng-include="'./suggestions/suggestion_yangxu.html'"></div>
				<div ng-show="stype==1" ng-include="'./suggestions/suggestion_yinxu.html'"></div>
				<div ng-show="stype==2" ng-include="'./suggestions/suggestion_tanshi.html'"></div>
				<div ng-show="stype==3" ng-include="'./suggestions/suggestion_yuzhi.html'"></div>
				<div ng-show="stype==4" ng-include="'./suggestions/suggestion_pixu.html'"></div>
				<div ng-show="stype==5" ng-include="'./suggestions/suggestion_shenxu.html'"></div>
				<div ng-show="stype==6" ng-include="'./suggestions/suggestion_qixu.html'"></div>
				<div ng-show="stype==7" ng-include="'./suggestions/suggestion_zhengchang.html'"></div>
			</div>
		</div>

		<script>
			function getPar(par){
				 //获取当前URL
				 var local_url = document.location.href;
				 //获取要取得的get参数位置
				 var get = local_url.indexOf(par +"=");
				 if(get == -1){
					 return false;  
				 }  
				 //截取字符串
				 var get_par = local_url.slice(par.length + get + 1);   
				 //判断截取后的字符串是否还有其他get参数
				 var nextPar = get_par.indexOf("&");
				 if(nextPar != -1){
					 get_par = get_par.slice(0, nextPar);
				 }
				 return get_par;
			 }
			var app = angular.module('myApp', ['ngMaterial', 'ngMessages']);
			app.controller('myCtrl', function($scope, $mdDialog){
				$scope.faceResult = "无面诊记录";
				$scope.tongueResult = "无舌诊记录";
				$scope.healthState = "身体棒棒哒";
				//$scope.templateUrl = './suggestions/suggestion_yangxu.html';
				// 建议类型
				$scope.stype = 7; // 健康
				$scope.date = Date();
				var faces = ["xiaolian2.jpg", "xiaolian.jpg", "pinglian.jpg", "pinglian2.jpg", "pinglian3.jpg"];
				$scope.HEALTH_INDEX = 0;
				//console.log(getPar("data"))
				pdata = getPar("data");

				if(pdata.length>0){
					console.log(decodeURI(pdata), decodeURI(pdata));
					var data = JSON.parse(decodeURI(pdata));
					if(null!=data.faceResult){
						$scope.faceResult = getfaceResult(data.faceResult);
					}
					if(null!=data.tongueResult){
						$scope.tongueResult = gettongueResult(data.tongueResult);
					}
					$scope.phy = data.phy;
					//data.healthScore = 65;
					$scope.healthScore = data.healthScore;
					// console.log(Math.floor(data.healthScore/20), 4-Math.floor(data.healthScore/20));
					$scope.HEALTH_INDEX = 4-Math.floor(parseInt(data.healthScore)/25);
					console.log($scope.HEALTH_INDEX)
					$scope.stype = data.mainType;

					if(data.healthScore>=0 && data.healthScore<=40){
						$scope.healthState = "身体较糟糕，可能需要去医院检查";
						$scope.phy += " 亚健康";
					}else if(data.healthScore>40 && data.healthScore<=80){
						$scope.healthState = "身体状况不佳";
						$scope.phy += " 亚健康";
					}else{
						$scope.healthState = "身体棒棒哒！";
					}
					console.log("处理data完成");
				}

				$scope.showExplainDialog = function(ev){
					$mdDialog.show({
						controller: DialogController,
						locals:{
							id: 1,
							qs: 2
						},
						templateUrl: './explain-dialog.tmpl.html',
						parent: angular.element(document.body),
						targetEvent: ev,
						clickOutsideToClose:false,
						fullscreen: $scope.customFullscreen, // Only for -xs, -sm breakpoints.
						onComplete: function(){    // 显示完成后的回调函数
							
						}
					})
					.then(function() {
						console.log("then")
					}, function() {
						$scope.status = 'You cancelled the dialog.';
					});
				};

				function DialogController($scope, $mdDialog, id, qs) {
					$scope.hide = function() {
						$mdDialog.hide();
						console.log("hide")
					};

					$scope.cancel = function(){
						$mdDialog.hide();
					}
				}
			});
			mui.init();
		</script>
	</body>
</html>
