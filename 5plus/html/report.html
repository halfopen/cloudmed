<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>健康自检</title>
		
		<script src="../js/mui.min.js"></script>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/app.css" rel="stylesheet" />
		<link href="../css/report.css" rel="stylesheet" />
		<script src="../data/question.js" ></script>
		<script src="../js/angular.min.js"></script>
		<script src="../js/angular-animate.min.js"></script>
		<script src="../js/angular-aria.min.js"></script>
		<script src="../js/angular-messages.min.js"></script>
		<script src="../js/diagnosis.js"></script>
	</head>
	<body>
		<base href="/html/" />
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">检测报告</h1>
		</header>
		
		<div class="mui-content" ng-app="myApp" ng-controller="myCtrl">
			<div class="tip">
				您在{{date}}的体检报告
			</div>
			<div class="col-box">
				<div>面诊结果</div>
				<p>{{faceResult}}</p>
			</div>
			<div class="col-box">
				<div>舌诊结果</div>
				<p>{{tongueResult}}</p>
			</div>
			<div class="col-box">
				<div>结论： {{phy}} {{healthScore}}分</div>
				<p>{{healthState}} <img alt="" src="{{HEALTH_INDEX_IMAGE}}" style="width: 120px; height: 120px"></p>
			</div>

			<div class="col-box">
				<div>建议</div>
				<suggestion stype="{{stype}}"></suggestion>
			</div>
		</div>

		<script>
			function getPar(par){
				 //获取当前URL
				 var local_url = document.location.href;
				 //获取要取得的get参数位置
				 var get = local_url.indexOf(par +"=");
				 if(get == -1){
					 return false;  
				 }  
				 //截取字符串
				 var get_par = local_url.slice(par.length + get + 1);   
				 //判断截取后的字符串是否还有其他get参数
				 var nextPar = get_par.indexOf("&");
				 if(nextPar != -1){
					 get_par = get_par.slice(0, nextPar);
				 }
				 return get_par;
			 }
			var app = angular.module('myApp', []);
			app.config(['$locationProvider', function($locationProvider) {
				$locationProvider.html5Mode(true);
			}]);
			app.controller('myCtrl', function($scope, $location){
				$scope.faceResult = "无面诊记录";
				$scope.tongueResult = "无舌诊记录";
				$scope.healthState = "身体棒棒哒";
				// 建议类型
				$scope.stype = 7; // 健康
				$scope.date = Date();
				var faces = ["xiaolian2.jpg", "pinglian.jpg", "pinglian2.jpg", "pinglian3.jpg", "kulian.jpg"];
				$scope.HEALTH_INDEX_IMAGE = "./resource/html/image/"+faces[0];
				console.log(getPar("data"))
				pdata = getPar("data");
				if(pdata.length>0){
					console.log(decodeURI(pdata), decodeURI(pdata));
					var data = JSON.parse(decodeURI(pdata));
					if(null!=data.faceResult){
						$scope.faceResult = getfaceResult(data.faceResult);
					}
					if(null!=data.tongueResult){
						$scope.tongueResult = gettongueResult(data.tongueResult);
					}
					$scope.phy = data.phy;
					$scope.healthScore = data.healthScore;
					$scope.HEALTH_INDEX_IMAGE = "./resource/html/image/"+faces[4-Math.floor(data.healthScore/20)];
					$scope.stype = data.mainType;

					if(data.healthScore>=0 && data.healthScore<=40){
						$scope.healthState = "身体较糟糕，可能需要去医院检查";
						$scope.phy += " 亚健康";
					}else if(data.healthScore>40 && data.healthScore<=80){
						$scope.healthState = "身体状况不佳";
						$scope.phy += " 亚健康";
					}else{
						$scope.healthState = "身体棒棒哒！";
					}
				}
			});
			app.directive('suggestion', function(){
				// 建议模板
				// "suggestion_xuexu.html"   ,好像没有血虚
				var templates = [
					"suggestion_yangxu.html",
					"suggestion_yinxu.html"  ,
					"suggestion_tanshi.html"  ,
					"suggestion_yuzhi.html", 
					"suggestion_pixu.html"  ,
					"suggestion_shenxu.html"  ,
					"suggestion_qixu.html"  ,
					"suggestion_zhengchang.html"];

				var url = templates[Math.floor(Math.random()*8)];
				//url = templates[1];
				console.log(url);
				return {
					template:'<div ng-include="getContentUrl()"></div>',
					replace: true,
					link: function($scope, $element, $attr){
						$scope.getContentUrl = function(){
							var template = "suggestions/"+templates[7];
							if(undefined != $attr.stype){
								template = "suggestions/"+templates[parseInt($attr.stype)];
							}
							return template;
						}
					}
				}
			});
			mui.init();
		</script>
	</body>
</html>
